from pathlib import Path
path = Path('src/powershell/MasterNerd.Bootstrap.ps1')
text = path.read_text(encoding='utf-8')
old = """function Invoke-UsbFormatWizard {\n    Write-Host \"[>] Abrindo CMD em modo administrador para formatação...\" -ForegroundColor Yellow\n    \n    # Cria script batch temporário que será executado no CMD elevado\n    $batchContent = @'\n@echo off\necho ========================================\necho FORMATACAO DE PENDRIVE - DISKPART\necho ========================================\necho.\ndiskpart\necho.\necho Formatacao concluida!\necho Pressione qualquer tecla para voltar ao PowerShell...\npause >nul\n'@\n    \n    $tempBatch = [System.IO.Path]::GetTempPath() + \"masternerd_format.bat\"\n    $batchContent | Set-Content -Path $tempBatch -Encoding ASCII\n    \n    try {\n        # Executa CMD como admin e aguarda conclusão\n        Start-Process \"cmd.exe\" -ArgumentList \"/k `\"$tempBatch`\"\" -Verb RunAs -Wait\n    }\n    finally {\n        Remove-Item $tempBatch -Force -ErrorAction SilentlyContinue\n    }\n    \n    Write-Host \"[OK] Retornando ao menu principal...\" -ForegroundColor Green\n}\n"""
new = """function Invoke-UsbFormatWizard {\n    Write-Host \"[>] Formatação automática do pendrive (diskpart)\" -ForegroundColor Yellow\n    Ensure-Admin\n\n    $usbDisks = Get-Disk | Where-Object BusType -eq 'USB'\n    if (-not $usbDisks) {\n        Write-Warning \"Nenhum pendrive USB detectado. Conecte o dispositivo e tente novamente.\"\n        return\n    }\n\n    Write-Host \"\"\n    Write-Host \"[USB] Discos removíveis detectados:\" -ForegroundColor Cyan\n    $usbDisks | ForEach-Object {\n        $sizeGB = [math]::Round($_.Size / 1GB, 2)\n        Write-Host (\"  Disk {0} - {1}GB - {2} - Status: {3}\" -f $_.Number, $sizeGB, $_.FriendlyName, $_.OperationalStatus)\n    }\n\n    Write-Host \"\"\n    Write-Host \"==================== ATENÇÃO ====================\" -ForegroundColor Red\n    Write-Host \"A formatação apagará TODOS OS DADOS do pendrive.\" -ForegroundColor Yellow\n    Write-Host \"Certifique-se de ter backup antes de continuar.\" -ForegroundColor Yellow\n    Write-Host \"================================================\" -ForegroundColor Red\n    Write-Host \"\"\n\n    $diskNum = Read-Host \"Digite o número do disco (ex: 1)\"\n    $targetDisk = $usbDisks | Where-Object Number -eq $diskNum\n    if (-not $targetDisk) {\n        throw \"Disco $diskNum não encontrado ou não é USB.\"\n    }\n\n    $confirm1 = Read-Host \"Digite o número do disco NOVAMENTE para confirmar\"\n    if ($confirm1 -ne $diskNum) {\n        throw \"Confirmação falhou. Operação cancelada.\"\n    }\n\n    $confirm2 = Read-Host \"Digite 'FORMATAR' (em maiúsculas) para prosseguir\"\n    if ($confirm2 -ne \"FORMATAR\") {\n        Write-Host \"Operação cancelada pelo usuário.\" -ForegroundColor Yellow\n        return\n    }\n\n    Write-Host \"[>] Preparando script diskpart (list disk -> select -> clean -> create -> format NTFS)...\" -ForegroundColor Yellow\n\n    $diskpartScript = @\"\nselect disk $diskNum\nlist disk\nclean\ncreate partition primary\nformat fs=ntfs quick\nassign\nexit\n\"@\n\n    $tempFile = [System.IO.Path]::GetTempFileName()\n    $diskpartScript | Set-Content -Path $tempFile -Encoding ASCII\n\n    try {\n        Write-Host \"[>] Executando diskpart...\" -ForegroundColor Yellow\n        $output = diskpart /s $tempFile 2>&1\n        $output | ForEach-Object { Write-Host $_ }\n\n        if ($LASTEXITCODE -eq 0) {\n            Write-Host \"[OK] Formatação concluída com sucesso!\" -ForegroundColor Green\n        } else {\n            throw \"Diskpart retornou erro. Código: $LASTEXITCODE\"\n        }\n    }\n    finally {\n        Remove-Item $tempFile -Force -ErrorAction SilentlyContinue\n    }\n}\n"""
if old not in text:
    raise SystemExit('old block not found')
path.write_text(text.replace(old,new,1), encoding='utf-8')
"}